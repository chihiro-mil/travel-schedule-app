{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ form_title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="{% static "css/style.css" %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <a href="{% url 'app:schedule_detail' schedule_id=schedule.id %}"class="back-button">＜戻る</a>
    <div class="plan-form-container">
        <h1 class="page-title">{{ form_title }}</h1>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="category-radio"> 

                <input type="radio" name="action_category" value="move" id="category-move"
                    {% if selected_category == "move" %}checked{% endif %}>
                <label for="category-move" class="label-move {% if form.instance.pk and selected_category != 'move' %}locked{% endif %}">移動</label>

                <input type="radio" name="action_category" value="sightseeing" id="category-sightseeing"
                    {% if selected_category == "sightseeing" %}checked{% endif %}>
                <label for="category-sightseeing" class="label-sightseeing {% if form.instance.pk and selected_category != 'sightseeing' %}locked{% endif %}">観光地</label>

                <input type="radio" name="action_category" value="meal" id="category-meal"
                    {% if selected_category == "meal" %}checked{% endif %}>
                <label for="category-meal" class="label-meal {% if form.instance.pk and selected_category != 'meal' %}locked{% endif %}">食事</label>

                <input type="radio" name="action_category" value="stay" id="category-stay"
                    {% if selected_category == "stay" %}checked{% endif %}>
                <label for="category-stay" class="label-stay {% if form.instance.pk and selected_category != 'stay' %}locked{% endif %}">宿泊</label>
            </div>

            <!--移動カテゴリ-->
            <div class="category-fields" data-category="move">
                <div class="transportation-row">
                    <div class="form-group">
                        <label class-"transportation-title">移動手段</label>
                        <div class="custom-select-box">
                            <div class="selected-option">
                                <i class="selected-icon"></i>
                                <span class="selected-label">選択してください</span>
                            </div>

                            <div class="options-list">
                                {% for method in transportation_methods %}
                                    <div class="option-item"
                                        data-id="{{ method.id }}"
                                        data-label="{{ method.label }}"
                                        data-icon="{{ method.icon }}">
                                        <i class="{{ method.icon }}"></i>
                                        <span class="transportation-label">{{ method.label }}</span>
                                    </div>
                                {% endfor %}
                                </div>
                                {% if form.transportation.errors %}
                                    <div class="error-message">{{ form.transportation.errors.0 }}</div>
                                {% endif %}
                                <input type="hidden"
                                    class="transportation-hidden-input"
                                    name="transportation"
                                    value="{% if form.data.transportation %}{{ form.data.transportation }}
                                        {% elif form.instance.transportation %}{{ form.instance.transportation.id }}{% else %}{% endif %}">
                            </div>
                        </div>
                    </div>

                <div class="form-group" id="move-start-date" >
                    <label id="move-start-date-label">出発日</label>
                    {{ form.start_date }}
                    {% if form.start_date.errors %}
                        <div class="error-message">
                            {% for error in form.start_date.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="move-start-time">
                    <label id="move-start-time-label">出発時刻</label>
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                        <div class="error-message">
                            {% for error in form.start_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="move-departure-location">
                    <label id="move-departure-location-label">出発地</label>
                    {{ form.departure_location }}
                    {% if form.departure_location.errors %}
                        <div class="error-message">
                            {% for error in form.departure_location.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="move-end-date">
                    <label id="move-end-date-label">到着日</label>
                    {{ form.end_date }}
                    {% if form.end_date.errors %}
                        <div class="error-message">
                            {% for error in form.end_date.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="move-end-time">
                    <label id="move-end-time-label">到着時刻</label>
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                        <div class="error-message">
                            {% for error in form.end_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="move-arrival-location">
                    <label id="move-arrival-location-label">到着地</label>
                    {{ form.arrival_location }}
                    {% if form.arrival_location.errors %}
                        <div class="error-message">
                            {% for error in form.arrival_location.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!--観光地カテゴリ-->

            <div class="category-fields" data-category="sightseeing">
                <div class="form-group" id="sightseeing-name">
                    <label id="sightseeing-name-label">観光地</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="error-message">
                            {% for error in form.name.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="sightseeing-start-date">
                    <label id="sightseeing-start-date-label">滞在開始日</label>
                    {{ form.start_date }}
                    {% if form.start_date.errors %}
                        <div class="error-message">
                            {% for error in form.start_date.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="sightseeing-start-time">
                    <label id="sightseeing-start-time-label">滞在開始時刻</label>
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                        <div class="error-message">
                            {% for error in form.start_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="sightseeing-end-date">
                    <label id="sightseeing-end-date-label">滞在終了日</label>
                    {{ form.end_date }}
                </div>

                <div class="form-group" id="sightseeing-end-time">
                    <label id="sightseeing-end-time-label">滞在終了時刻</label>
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                        <div class="error-message">
                            {% for error in form.end_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>


            <!--食事カテゴリ-->
            <div class="category-fields" data-category="meal">
                <div class="form-group" id="meal-name">
                    <label id="meal-name-label">店名</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="error-message">
                            {% for error in form.name.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="meal-start-date">
                    <label id="meal-start-date-label">食事日</label>
                    {{ form.start_date }}
                    {% if form.start_date.errors %}
                        <div class="error-message">
                            {% for error in form.start_date.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="meal-start-time">
                    <label id="meal-start-time-label">食事開始時刻</label>
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                        <div class="error-message">
                            {% for error in form.start_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="meal-end-time">
                    <label id="meal-end-time-label">食事終了時刻</label>
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                        <div class="error-message">
                            {% for error in form.end_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!--宿泊カテゴリ-->

            <div class="category-fields" data-category="stay">
                <div class="form-group" id="stay-name">
                    <label id="stay-name-label">宿泊先</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="error-message">
                            {% for error in form.name.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="stay-start-date">
                    <label id="stay-start-date-label">チェックイン</label>
                    {{ form.start_date }}
                    {% if form.start_date.errors %}
                        <div class="error-message">
                            {% for error in form.start_date.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="stay-start-time">
                    <label id="stay-start-time-label">チェックイン<br>時間</label>
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                        <div class="error-message">
                            {% for error in form.start_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="stay-end-date">
                    <label id="stay-end-date-label">チェックアウト</label>
                    {{ form.end_date }}
                    {% if form.end_date.errors %}
                        <div class="error-message">
                            {% for error in form.end_date.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group" id="stay-end-time">
                    <label id="stay-end-time-label">チェックアウト<br>時間</label>
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                        <div class="error-message">
                            {% for error in form.end_time.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="common-fields is-hidden">

                <div class="form-group">
                    <label for="{{ form.memo.id_for_label }}">メモ</label>{{ form.memo }}
                </div>

                <div class="form-group link-formset-container">
                    <label class="url-label">ＵＲＬ(最大５件)</label>
                    {{ link_formset.management_form }}
                    <div id="link-form-container">
                        {% for form in link_formset %}
                            {% if not form.empty_form %}
                                <div class="link-form-block">
                                    {{ form.id }}
                                    <div class="link-inputs">
                                        {{ form.title }}
                                        {{ form.title.errors }}
                                        {{ form.url }}
                                        {{ form.url.errors }}
                                    </div>
                                    <input type="checkebox"
                                            name="{{ form.DELETE.html_name }}"
                                            id="{{ form.DELETE.id_for_label }}"
                                            style="display:none;">
                                    <button type="button" class="remove-link">削除</button>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <script type="text/template" id="empty-link-template">
                    <div class="link-form-block">
                        {{ link_formset.empty_form.id }}
                        <div class="link-inputs">
                            {{ link_formset.empty_form.title }}
                            {{ link_formset.empty_form.url }}
                        </div>
                        <input type="checkebox"
                                name="{{ link_formset.empty_form.DELETE.html_name }}"
                                id="{{ link_formset.empty_form.DELETE.id_for_label }}"
                                hidden>
                        <button type="button" class="remove-link">削除</button>
                    </div>
                </script>

                <button type="button" id="add-link">＋ 追加</button>

                <div class="form-group picture-formset-container" id="picture-form-container">
                    <label class="picture-label">写真(最大６枚)</label>
                    {{ picture_formset.management_form }}
                    <div id="picture-inputs">
                        {% for form in picture_formset %}
                            <div class="picture-form-block"
                                data-has-image="{% if form.instance.pk and form.instance.image %}1{% else %}0{% endif %}">
                                {{ form.id }}

                                <div class="image-preview-wrapper"
                                        {% if form.instance.pk and form.instance.image %}
                                            style="display:block;"
                                        {% else %}
                                            style="display:none;"
                                        {% endif %}>
                                    <img
                                        src="{% if form.instance.pk and form.instance.image %}{{ form.instance.image.url }}{% else %}{% endif %}"
                                        alt="画像"
                                        class="preview-image">
                                </div>

                                <div class="file-input-wrapper" 
                                    data-has-image="{% if form.instance.pk and form.instance.image %}1{% else %}0{% endif %}"
                                    {% if form.instance.pk and form.instance.image %}
                                        style="display:none;"
                                    {% else %}
                                        style="display:block;"
                                    {% endif %}>
                                    {{ form.image }}
                                </div>

                                <input type="checkebox"
                                    name="{{ form.DELETE.html_name }}"
                                    id="{{ form.DELETE.id_for_label }}"
                                    style="display:none;">

                                <button type="button" class="remove-picture"
                                        {% if form.instance.pk and form.instance.image %}
                                            style="display:inline-block;"
                                        {% else %}
                                            style="display:none;"
                                        {% endif %}>
                                    削除
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <script type="text/template" id="empty-picture-template">
                    <div class="picture-form-block">
                        {{ picture_formset.empty_form.id }}

                        <div class="image-preview-wrapper" style="display:none;">
                            <img src="" alt="プレビュー" class="preview-image">
                        </div>

                        <div class="file-input-wrapper">
                            {{ picture_formset.empty_form.image }}
                        </div>

                        <input type="checkebox"
                                name="{{ picture_formset.empty_form.DELETE.html_name }}"
                                id="{{ picture_formset.empty_form.DELETE.id_for_label }}"
                                style="display:none;">

                        <button type="button" class="remove-picture" style="display:none;">
                            削除
                        </button>
                    </div>
                </script>

                <button type="button" id="add-picture">＋ 追加</button>


                <div class="form-group common-submit">
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </div>
                
        </form>
    </div>

    <footer class="footer-nav">
        <ul>
            <li>
                <a href="{% url 'app:home' %}">
                    <span class="footer-icon-label">
                        <i class="fas fa-home"></i><br>ホーム
                    </span>
                </a>
            </li>
            <li>
                <a href="{% url 'app:plan_create_or_edit' schedule_id=schedule_id %}">
                    <span class="footer-icon-label disabled-link">
                        <i class="fas fa-plus-square"></i><br>予定追加
                    </span>
                </a>
            </li>
            <li>
                <a href="{% url 'app:mypage' %}">
                    <span class="footer-icon-label">
                        <i class="fas fa-user-cog"></i><br>マイページ設定
                    </span>
                </a>
            </li>
            <li>
                <a href="{% url 'app:logout' %}">
                    <span class="footer-icon-label">
                        <i class="fas fa-sign-out-alt"></i><br>ログアウト
                    </span>
                </a>
            </li>
        </ul>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            /*参照をまとめて取る*/
            const allCategoryForms = document.querySelectorAll('.category-fields');
            const radios = document.querySelectorAll('input[name="action_category"]');
            const commonFields = document.querySelector('.common-fields');

            /*共通フォームの表示・非表示*/
            const hideAndDisable = (block) => {
                block.classList.add('is-hidden');
                block.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
            };
            const showAndEnable = (block) => {
                block.classList.remove('is-hidden');
                block.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
            };

            /*ページ読み込み時、全カテゴリと共通フォーム隠す*/
            allCategoryForms.forEach(block => {
                block.classList.add('is-hidden');
                block.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
            });
            if (commonFields) commonFields.classList.add('is-hidden');

            /*編集画面対応: 既存のカテゴリを復元*/
            const checkedRadio = document.querySelector('input[name="action_category"]:checked');
            if (checkedRadio) {
                const selected = checkedRadio.value;
                const target = document.querySelector(`.category-fields[data-category="${selected}"]`);
                if (target) {
                    showAndEnable(target);
                    if (selected === "move") {
                        initTransportationSelect();
                    }
                }
                if (commonFields) commonFields.classList.remove('is-hidden');
            }


            /**ラジオ切り替え*/
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const sel = this.value;
                    allCategoryForms.forEach(block => {
                        if (block.dataset.category === sel) {
                            showAndEnable(block);
                            if (sel === "move") {
                                initTransportationSelect();
                            }
                        } else {
                            hideAndDisable(block);
                        }
                    });
                    if (commonFields) commonFields.classList.remove('is-hidden');
                });
            });

            /*移動手段セレクト*/
            function initTransportationSelect() {
                const selectBoxes = document.querySelectorAll('.custom-select-box');

                selectBoxes.forEach(box => {
                    const selectedOption = box.querySelector('.selected-option');
                    const optionsList = box.querySelector('.options-list');
                    const hiddenInput = box.querySelector('.transportation-hidden-input');
                    const selectedLabel = box.querySelector('.selected-label');
                    const selectedIcon = box.querySelector('.selected-icon');

                    if (!selectedOption || !optionsList) return;

                    /*バリエーション後の移動手段復元*/
                    /*if (hiddenInput && hiddenInput.value) {
                        const matchedItem = Array.from(optionsList.querySelectorAll('.option-item'))
                            .find(item => item.dataset.id === hiddenInput.value);
                        if (matchedItem) {
                            selectedLabel.textContent = matchedItem.dataset.label;
                            if (selectedIcon && matchedItem) {
                                selectedIcon.className = matchedItem.dataset.icon;
                            }
                        }
                    }*/
                    
                    /*選択処理(古いイベントを消す、新しい要素に置き換え)*/
                    optionsList.querySelectorAll('.option-item').forEach(item => {
                        const newItem = item.cloneNode(true);
                        item.parentNode.replaceChild(newItem, item);

                        newItem.addEventListener('click', () => {
                            hiddenInput.value = newItem.dataset.id;
                            selectedLabel.textContent = newItem.dataset.label;
                            if (selectedIcon) {
                                selectedIcon.className = newItem.dataset.icon;
                            }
                            optionsList.classList.remove('active');
                        });
                    });

                    /*開閉処理*/
                    selectedOption.addEventListener('click', () => {
                        optionsList.classList.toggle('active');
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select-box')) {
                        document.querySelectorAll('.options-list').forEach(list => {
                            list.classList.remove('active');
                        });
                    }
                });
            }
    
            /*フッタースクロール機能*/
            let lastScrollTop = 0;
            const footer = document.querySelector('.footer-nav');

            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if (scrollTop > lastScrollTop) {
                    footer.style.transform = 'translateY(100%)';
                } else {
                    footer.style.transform = 'translateY(0)';
                }
                lastScrollTop = scrollTop <= 0 ? 0 :scrollTop;
            });

            /*バリエーション後の移動手段復元*/
            const hiddenInput = document.querySelector('.transportation-hidden-input');
            if (hiddenInput && hiddenInput.value) {
                initTransportationSelect();
            }

            /*リンク*/
            const linkContainer = document.getElementById('link-form-container');
            const linkAddBtn = document.getElementById('add-link');
            const linkTotalInput = document.getElementById('id_links-TOTAL_FORMS');
            const LINK_MAX = 5;
            const templateHTML = document.getElementById('empty-link-template').textContent;

            /*表示されているフォーム数を返す*/
            function visibleLinkCount() {
                return linkContainer.querySelectorAll('.link-form-block:not([data-deleted="1"])').length;
            }

            /*linkTotalInput.value = visibleLinkCount();*/

            function updateLinkAddState() {
                linkAddBtn.disabled = visibleLinkCount() >= LINK_MAX;
            }

            /*既存ブロックにdata-index付与*/
            function bootstrapBlockIndex() {
                linkContainer.querySelectorAll('.link-form-block').forEach(block => {
                    if (block.dataset.index) return;
                    const anyInput = block.querySelector('input[name^="links-"]');
                    const m = anyInput && anyInput.name.match(/links-(\d+)-/);
                    if (m) block.dataset.index = m[1];
                });
            }

            /*初期化　トータルは生成済の枠の総数*/
            bootstrapBlockIndex();
            linkTotalInput.value = linkContainer.querySelectorAll('.link-form-block').length;
            updateLinkAddState();

            /*追加処理*/
            linkAddBtn.addEventListener('click', function () {
                if ( visibleLinkCount() >= LINK_MAX) return;

                const index = parseInt(linkTotalInput.value, 10);
                const html = templateHTML.replace(/__prefix__/g, index);

                const tpl = document.createElement('template');
                tpl.innerHTML = html.trim();
                const newBlock = tpl.content.querySelector('.link-form-block');
                newBlock.dataset.index = String(index);
                linkContainer.appendChild(newBlock);

                linkTotalInput.value = index + 1;
                updateLinkAddState();
            });

            /*削除処理*/
            linkContainer.addEventListener('click', function (e) {
                if (!e.target.classList.contains('remove-link')) return;

                const targetBlock = e.target.closest('.link-form-block');
                if (!targetBlock) return;

                const idx = Number(targetBlock.dataset.index ?? '-1');
                const del = targetBlock.querySelector('input[name$="-DELETE"]');

                if (idx === 0) {
                    targetBlock.querySelectorAll('input[type="text"], input[type="url"]').forEach(i => i.value = '');
                    if (del) { del.checked = false; del.value = ""; }
                } else {
                    targetBlock.querySelectorAll('input[type="text"], input[type="url"]').forEach(i => i.value = '');
                    if (del) { del.checked = true; del.value = "on"; }
                    targetBlock.style.display = 'none';
                    targetBlock.dataset.deleted = '1';
                }
                updateLinkAddState();
            });

            /*写真*/
            const pictureList = document.querySelector('#picture-form-container #picture-inputs');
            const pictureAddBtn = document.getElementById('add-picture');
            const pictureTotalInput = document.getElementById('id_pictures-TOTAL_FORMS');
            const PICTURE_MAX = 6;
            const pictureTemplateHTML = document.getElementById('empty-picture-template').innerHTML;

            /*追加ボタンの有効/無効を制御*/
            function updatePictureAddState() {
                const blocks = pictureList.querySelectorAll('.picture-form-block');

                let visibleCount = 0;
                blocks.forEach(block => {
                    const del = block.querySelector('input[name$="-DELETE"]');
                    const isVisible = block.style.display !== 'none';

                    if (isVisible) {
                        visibleCount++;
                    }
                });

                pictureAddBtn.disabled = visibleCount >= PICTURE_MAX;

                return visibleCount;
            }


            /*プレビュー表示処理*/
            function showPreview(fileInput) {
                const block = fileInput.closest('.picture-form-block');
                const previewWrapper = block.querySelector('.image-preview-wrapper');
                const previewImage = block.querySelector('.preview-image');
                const removeBtn = block.querySelector('.remove-picture');
                const fileWrapper = block.querySelector('.file-input-wrapper');

                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        if (previewImage) previewImage.src = e.target.result;
                        if (previewWrapper) previewWrapper.style.display = 'block';
                        if (removeBtn) removeBtn.style.display = 'inline-block';
                        if (fileWrapper) fileWrapper.style.display = 'none';
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                }
            }

            /*新しいフォームを追加*/

            function onAddPicture() {
                const count = updatePictureAddState();
                if (count >= PICTURE_MAX) return;

                const index = parseInt(pictureTotalInput.value, 10);
                const wrap = document.createElement('div');
                wrap.innerHTML = pictureTemplateHTML.replace(/__prefix__/g, index);
                const block = wrap.firstElementChild;

                pictureList.appendChild(block);

                const fileInput = block.querySelector('input[type="file"]');
                if (fileInput)  { 
                    fileInput.addEventListener('change', function () { 
                        const f = this.files && this.files[0];
                        if (!f) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            block.querySelector('.preview-image').src = e.target.result;
                            block.querySelector('.image-preview-wrapper').style.display = 'block';
                            block.querySelector('.file-input-wrapper').style.display = 'none';
                            const rm = block.querySelector('.remove-picture');
                            if (rm) rm.style.display = 'inline-block';
                        };
                        reader.readAsDataURL(f); 
                    });
                }

                const rmBtn = block.querySelector('.remove-picture');
                if (rmBtn) {
                    rmBtn.addEventListener('click', function () {
                        const del = block.querySelector('input[name$="-DELETE"]');
                        if (del) { del.checked = true; del.value = 'on'; }
                        block.style.display = 'none';
                        updatePictureAddState();
                    });
                }
                pictureTotalInput.value = index + 1;
                updatePictureAddState();
            }

            /*削除処理*/
            pictureList.addEventListener('click', function (e) {
                const btn = e.target.closest('button.remove-picture');
                if (!btn) return;

                const block = btn.closest('.picture-form-block');
                if (!block) return;

                const allBlocks = Array.from(pictureList.querySelectorAll('.picture-form-block'));
                const firstBlock = allBlocks[0];

                const del = block.querySelector('input[name$="-DELETE"]');
                const isInput = block.querySelector('input[name$="-id"]');
                const isExisting = isInput && isInput.value && isInput.value.trim() !== '';
                const fileInput = block.querySelector('input[type="file"]');
                const previewWrapper = block.querySelector('.image-preview-wrapper');
                const previewImage = block.querySelector('.preview-image');
                const removeBtn = block.querySelector('.remove-picture');
                const fileWrapper = block.querySelector('.file-input-wrapper');

                if (del) {
                    if (isExisting){
                        del.checked = true;
                        del.value = 'on';
                    } else {
                        del.checked = false;
                        del.value = '';
                    }
                }

                if (block === firstBlock) {
                    block.style.display = 'flex';
                    block.dataset.hasImage = '0';

                    if (previewWrapper) previewWrapper.style.display = 'none';
                    if (previewImage) previewImage.src = '';
                    if (removeBtn) removeBtn.style.display = 'none';
                    if (fileWrapper) fileWrapper.style.display = 'flex';
                    if (fileInput) fileInput.value = '';

                    updatePictureAddState();
                    return;
                }
                block.style.display = 'none';
                updatePictureAddState();
            });

            if (pictureAddBtn && !pictureAddBtn.dataset.bound) {
                pictureAddBtn.dataset.bound = '1';
                pictureAddBtn.addEventListener('click', onAddPicture);
            }
            updatePictureAddState();

            /*初期ロード時のfile inputにプレビュー表示を付与*/
            pictureList.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', function() {
                    showPreview(input);
                });
            });
            updatePictureAddState();
        });
    </script>
</body>
</html>