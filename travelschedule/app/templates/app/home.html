{% load static %}
{% load tz %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home page</title>
    <link rel="stylesheet" href="{% static "css/style.css" %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static "app/flatpickr/flatpickr.min.css" %}">
    <script src="{% static 'app/flatpickr/flatpickr.min.js' %}"></script>
    <script src="{% static 'app/flatpickr/ja.js' %}"></script>
    <script src="{% static 'app/flatpickr-yearSelect/flatpickr-year-select-plugin.js' %}"></script>
</head>
<body>

    <div class="home-header">
        <i class="fas fa-house house-icon"></i>
        <span class="home-title">予定表一覧</span>
        <a href="?sort={{ next_sort }}" class="sort-button">
            並び替え<br>({{ sort_label }})
        </a>
    </div>


    {% if no_schedules %}
        <div class="no-schedule-message">
            下の「予定表追加ボタン」から予定表を作成してみましょう！
        </div>
    {% endif %}

    {% for schedule in schedules %}
        <div class="schedule-card-wrapper" style="position: relative;">

            <div class="schedule-card">

                <a href="{% url 'app:schedule_detail' schedule.id %}" class="schedule-link"></a>

                <div class="kebab-menu no-link">
                    <i class="fas fa-ellipsis-v kebab-icon"></i>
                    <div class="kebab-dropdown hidden">

                        <button class="edit-schedule-btn edit-button" 
                                data-schedule-id="{{ schedule.id }}"
                                data-title="{{ schedule.title }}"
                                data-start="{{ schedule.trip_start_date }}"
                                data-end="{{ schedule.trip_end_date }}">
                            旅行タイトル<br>旅行期間の変更
                        </button>

                        <button class="delete-schedule-btn no-link" 
                                data-schedule-id="{{ schedule.id }}">
                            予定表を削除
                        </button>
                    </div>
                </div>

                <div class="schedule-header">
                    <strong>{{ schedule.title|break_every|safe }}</strong>
                </div>
                <p>{{ schedule.trip_start_date }} ～ {{ schedule.trip_end_date }}</p>
            </div>
        </div>
    {% endfor %}


    <footer class="footer-nav">
        <ul>
            <li>
                <a href="{% url 'app:home' %}">
                    <span class="footer-icon-label">
                        <i class="fas fa-home"></i><br>ホーム
                    </span>
                </a>
            </li>
            <li>
                <a href="#" id="openModalBtn">
                    <span class="footer-icon-label">
                        <i class="fas fa-plus-square"></i><br>予定表追加
                    </span>
                </a>
            </li>
            <li>
                <a href="{% url 'app:mypage' %}">
                    <span class="footer-icon-label">
                        <i class="fas fa-user-cog"></i><br>マイページ設定
                    </span>
                </a>
            </li>
            <li>
                <a href="{% url 'app:logout' %}">
                    <span class="footer-icon-label">
                        <i class="fas fa-sign-out-alt"></i><br>ログアウト
                    </span>
                </a>
            </li>
        </ul>
    </footer>

    <div id="modal" class="modal schedule-add-modal {% if show_add_modal %}{% else %}hidden{% endif %}">
        <div class="modal-content">
            <span id="closeModalBtn" class="close">&times;</span>
            <h2>予定表追加</h2>
            <form method="POST" action="{% url 'app:home' %}">
                {% csrf_token %}

                
                <label>旅行タイトル <span class="home-required-label">必須</span></label>
                <div class="home-required-wrapper">
                    <input type="text" name="title" maxlength="20" required>
                </div><br>

                <label>旅行期間 <span class="home-required-label">必須</span></label>
                <div class="calendar-wrapper">
                    <input type="text" id="dateRange" name="trip_period" placeholder="日付を選択" readonly class="flatpickr-input">
                    <input type="hidden" id="add_start_date" name="trip_start_date" value="">
                    <input type="hidden" id="add_end_date" name="trip_end_date" value="">
                </div><br>

                {% if form.trip_start_date.errors %}
                    <p class="home-error-message">{{ form.trip_start_date.errors.0 }}</p>
                {% endif %}

                <button type="submit" class="save-btn">保存</button>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal schedule-edit-modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span class="schedule-edit-modal-title">タイトル・旅行期間の変更</span>
                <span class="close" id="editModalClose">&times;</span>
            </div>
            
            <form id="editModalForm" method="POST" action="{% url 'app:edit_schedule_title' %}">
                {% csrf_token %}
                <input type="hidden" name="schedule_id" id="editScheduleId">

                <div class="schedule-form-group">
                    <label for="editTitle">旅行タイトル</label>
                    <input type="text" name="title" id="editTitle" maxlength="20" required>
                </div>

                <div class="schedule-form-group">
                    <label for="editTripRange">旅行期間</label>
                    <input type="text" id="editTripRange" placeholder="旅行期間を選択" readonly class="flatpickr-input">
                    
                    <input type="hidden" id="edit_start_date" name="start_date" value="">
                    <input type="hidden" id="edit_end_date" name="end_date" value="">
                </div>
                <p class="trip-warning">
                    ※旅行期間を短く変更すると、期間外の予定は自動的に削除されます。<br>宿泊など期間をまたぐ予定も一部が期間外になると削除されます。<br>削除された予定は元に戻せません。
                    <br>
                    <span class="trip-warning-example">（例：旅行期間を8/1～8/4➡8/2～8/3に変更は、<br>8/1と8/4の予定や8/1～8/4の宿泊予定は削除）</span>
                </p>

                <button type="submit" class="editSaveBtn schedule-edit-save">保存</button>
            </form>
        </div>
    </div>

    {% for schedule in schedules %}
        <div id="deleteModal" class="modal schedule-delete-modal hidden">
            <div class="modal-content">
                <p>予定表を削除してよろしいですか？</p>
                <form method="POST" action="{% url 'app:delete_schedule' schedule.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="schedule_id" id="deleteScheduleId">
                    <div style="text-align: center; margin-top: 10px;">
                        <button type="submit" class="delete-confirm-yes">はい</button>
                        <button type="button" id="cancelDeleteBtn" class="delete-confirm-no">いいえ</button>
                    </div>
                </form>
            </div>
        </div>
    {% endfor %}
    <div id="modal-overlay" class="modal-overlay hidden"></div>




    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const deleteModal = document.getElementById("deleteModal");
            if (deleteModal && !deleteModal.classList.contains("schedule-delete-modal", "hidden")) {
                deleteModal.classList.add("schedule-delete-modal", "hidden");
            }

            /*旅行期間追加用flatpickr*/

            function initAddRangePicker() {
                const input = document.querySelector("#dateRange");
                if (!input) return;

                const addStart = document.getElementById("add_start_date");
                const addEnd = document.getElementById("add_end_date");
                const thisYear = new Date().getFullYear();

                flatpickr(input, {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "Y年n月j日",
                    locale: "ja",
                    mondthSelectorType: "static",
                    plugins: [
                        new yearSelectPlugin({
                            shorthand:false,
                            dateFormat:"Y",
                            theme:"light"
                        }),
                    ],

                    defaultDate: [
                        addStart.value || input.dataset.start || null,
                        addEnd.value || input.dataset.end || null
                    ].filter(Boolean),

                    onChange(selectedDates, _str, instance) {
                        if (selectedDates.length === 2) {
                            addStart.value = instance.formatDate(selectedDates[0], "Y-m-d");
                            addEnd.value = instance.formatDate(selectedDates[1], "Y-m-d");
                        } else {
                            addStart.value = "";
                            addEnd.value = "";
                        }
                    }
                });
            }

            initAddRangePicker();

            /*旅行期間編集用flatpickr*/
            function initEditRangePicker() {
                const input = document.querySelector("#editTripRange");
                if (!input) return;

                const editStart = document.getElementById("edit_start_date");
                const editEnd = document.getElementById("edit_end_date");
                const hiddenStart = document.getElementById("edit_start_date");
                const hiddenEnd = document.getElementById("edit_end_date");
                const thisYear = new Date().getFullYear();

                flatpickr(input, {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "Y年n月j日",
                    locale: "ja",
                    mondthSelectorType: "static",
                    plugins: [
                        new yearSelectPlugin({
                            shorthand:false,
                            dateFormat:"Y",
                            theme:"light"
                        }),
                    ],

                    defaultDate: [
                        editStart.value || null,
                        editEnd.value || null
                    ],

                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length === 2) {
                            const start = instance.formatDate(selectedDates[0], "Y-m-d");
                            const end = instance.formatDate(selectedDates[1], "Y-m-d");
                            hiddenStart.value = start;
                            hiddenEnd.value = end;
                        } else {
                            editStart.value = "";
                            editEnd.value = "";
                        }
                    }
                });
            }
            initEditRangePicker();

            /*予定表追加モーダル用カレンダー*/
            const modal = document.getElementById("modal");
            const openBtn = document.getElementById("openModalBtn");
            const closeBtn = document.getElementById("closeModalBtn");

            if (openBtn && closeBtn && modal) {
                openBtn.onclick = function (e) {
                    e.preventDefault();
                    modal.classList.remove("hidden");
                };

                if (typeof showAddModal !== "undefined" && showAddModal) {
                    modal.classList.remove("hidden");
                }

                const hiddenStart = document.querySelector('input[name="start_date"]');
                const hiddenEnd = document.querySelector('input[name="end_date"]');


                if (hiddenStart && hiddenEnd) {
                    const originalStart = hiddenStart.dataset.original;
                    const originalEnd = hiddenEnd.dataset.original;
                }

                closeBtn.onclick = function () {
                    modal.classList.add("hidden");
                };
            }


            /*ケバブメニュー開閉*/
            document.querySelectorAll(".schedule-card-wrapper").forEach(wrapper => {
                const icon = wrapper.querySelector(".kebab-icon");
                const dropdown = wrapper.querySelector(".kebab-dropdown");

                if(icon && dropdown) {
                    icon.addEventListener("click", (e) => {
                        e.stopPropagation();
                        document.querySelectorAll(".kebab-dropdown").forEach(menu => {
                            menu.classList.add("hidden");
                        });
                        dropdown.classList.toggle("hidden");
                    });

                    dropdown.querySelectorAll("button").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                    });
                    });
                }
            });

            document.addEventListener("click", () => {
                document.querySelectorAll('.kebab-dropdown').forEach(menu => {
                    menu.classList.add("hidden");
                });
            });


            document.querySelectorAll(".schedule-link").forEach(link => {
                link.addEventListener("click", (e) => {
                    if (e.target.closest("kebab-menu")) {
                        e.preventDefault();
                    }
                });
            });



            document.querySelectorAll(".edit-button").forEach(button => {
                button.addEventListener("click", function () {
                    const scheduleId = this.dataset.scheduleId;
                    const title = this.dataset.title;
                    const start = this.dataset.start;
                    const end = this.dataset.end;

                    document.getElementById("editScheduleId").value = scheduleId;
                    document.getElementById("editTitle").value = title;
                    document.getElementById("edit_start_date").value = start;
                    document.getElementById("edit_end_date").value = end;

                    const rangeInput = document.getElementById("editTripRange");
                    if (rangeInput && start && end) {
                        rangeInput._flatpickr.setDate([start, end], true);
                    }

                    document.getElementById("editModal").classList.remove("schedule-edit-modal", "hidden");
                });
            });

            const editModalCloseBtn = document.getElementById("editModalClose");
            if (editModalCloseBtn) {
                editModalCloseBtn.addEventListener("click", function () {
                    document.getElementById("editModal").classList.add("schedule-edit-modal", "hidden");
                });
            }

            document.querySelectorAll(".edit-schedule-btn").forEach(function (button) {
                button.addEventListener("click", function () {
                    const scheduleId = this.dataset.scheduleId;
                    const title = this.dataset.title;
                    const start = this.dataset.start;
                    const end = this.dataset.end;

                    document.getElementById("editScheduleId").value = scheduleId;
                    document.getElementById("editTitle").value = title;

                    const hiddenStart = document.getElementById("edit_start_date");
                    const hiddenEnd = document.getElementById("edit_end_date");
                    hiddenStart.value = start || "";
                    hiddenEnd.value = end || "";

                    const rangeInput = document.getElementById("editTripRange");
                    if (rangeInput && start && end) {
                        rangeInput._flatpickr.setDate([start, end], true);
                    }

                    document.getElementById("editModal").classList.remove("schedule-edit-modal", "hidden");
                });

                /*保存ボタンタップ後　flatpickrの値をhiddnに反映*/

                const editForm = document.getElementById("editModalForm");

                editForm.addEventListener("submit", function (e) {
                    const rangeInput = document.getElementById("editTripRange");
                    const hiddenStart = document.getElementById("edit_start_date");
                    const hiddenEnd = document.getElementById("edit_end_date");

                    if (rangeInput._flatpickr && rangeInput._flatpickr.selectedDates.langth === 2) {
                        const [start, end] = rangeInput.value.split(" ～ ");
                        hiddenStart.value = start;
                        hiddenEnd.value = end;
                    }
                });
            });


            /*消去モーダル*/

            const overlay = document.getElementById('modal-overlay');

            function closeDeleteModal() {
                if (deleteModal && !deleteModal.classList.contains('hidden')) {
                    deleteModal.classList.add('hidden');
                }
                if (overlay) overlay.classList.add('hidden');
                document.body.classList.remove('modal-open');
                const input = document.getElementById('deleteScheduleId');
                if (input) input.value = '';
            }
            
            document.querySelectorAll(".delete-schedule-btn").forEach(button => {
                button.addEventListener("click", () => {
                    const scheduleId = button.dataset.scheduleId;
                    document.getElementById("deleteScheduleId").value = scheduleId;
                    deleteModal.classList.remove('hidden');

                    if (overlay) overlay.classList.remove('hidden');
                    document.body.classList.add('modal-open');
                });
            });

            const deleteModalCloseBtn = document.getElementById("deleteModalClose");
            if (deleteModalCloseBtn) {
                deleteModalCloseBtn.addEventListener("click", closeDeleteModal);
            }

            const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
            if (cancelDeleteBtn) {
                cancelDeleteBtn.addEventListener("click", closeDeleteModal);
            }

            if (overlay) {
                overlay.addEventListener('click', closeDeleteModal);
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !deleteModal.classList.contains('hidden')) {
                    closeDeleteModal();
                }
            });

            /*予定追加モーダルキャンセルボタン*/
            const addModal = document.getElementById("modal");
            const closeAddModalBtn = document.getElementById("closeAddModalBtn");

            if (addModal && closeAddModalBtn) {
                closeAddModalBtn.addEventListener("click", function () {
                    addModal.classList.add("schedule-add-modal", "hidden");
                });
            }


            let lastScrollTop = 0;
            const footer = document.querySelector('.footer-nav');


            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if (scrollTop > lastScrollTop) {
                    footer.style.transform = 'translateY(100%)';
                } else {
                    footer.style.transform = 'translateY(0)';
                }
                lastScrollTop = scrollTop <= 0 ? 0 :scrollTop;
            });
        });
    </script>
</body>
</html>